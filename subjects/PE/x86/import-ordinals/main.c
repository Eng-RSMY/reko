// main.c
// Generated by decompiling main.exe
// using Reko decompiler version 0.6.2.0.

#include "main.h"

void fn00401000()
{
	return;
}

word32 fn00401010(word32 dwArg04)
{
	word32 esp_13;
	word32 ebp_14;
	word32 esi_15;
	byte SCZO_16;
	word32 ecx_17;
	word32 eax_18;
	_acrt_iob_func();
	fn00401000();
	word32 esp_38;
	word32 ebp_39;
	word32 esi_40;
	byte SCZO_41;
	word32 ecx_42;
	word32 eax_43;
	_stdio_common_vfprintf();
	return 0x01;
}

word32 fn00401040()
{
	word32 esp_10;
	word32 ebp_11;
	word32 ecx_12;
	word32 eax_13;
	byte SCZO_14;
	byte SZO_15;
	byte C_16;
	driver.dll!Ordinal_1();
	word32 esp_20;
	word32 ebp_21;
	word32 ecx_22;
	word32 eax_23;
	byte SCZO_24;
	byte SZO_25;
	byte C_26;
	driver.dll!Ordinal_2();
	word32 esp_30;
	word32 ebp_31;
	word32 ecx_32;
	word32 eax_33;
	byte SCZO_34;
	byte SZO_35;
	byte C_36;
	driver.dll!Ordinal_4();
	word32 esp_40;
	word32 ebp_41;
	word32 ecx_42;
	word32 eax_43;
	byte SCZO_44;
	byte SZO_45;
	byte C_46;
	driver.dll!Ordinal_3();
	fn00401010(0x00402118);
	return 0x00;
}

Eq_62 Win32CrtStartup()
{
	ptr32 ecx_2 = fn0040165E();
	struct Eq_67 * ebp_12 = fn00401980(ecx_2, ebx, esi, edi, dwLoc0C, 0x00402508, 0x14);
	*(fp - 0x0C) = 0x01;
	word32 * esp_19 = fp - 0x08;
	if (fn0040146F(edx, dwArg00) == 0x00)
	{
l00401172:
		esp_19 = esp_19 - 0x04;
		*esp_19 = 0x07;
		fn0040176D(0x14, dwArg00);
	}
	*(ebp_12 - 0x19) = 0x00;
	*(ebp_12 - 0x04) = *(ebp_12 - 0x04) & 0x00;
	*(ebp_12 - 0x24) = fn0040143A(0x14);
	ebx = DPB(ebx, 0x00, 0);
	word32 eax_37 = globals->dw403334;
	if (eax_37 != 0x01)
	{
		Eq_62 eax_192;
		if (eax_37 == 0x00)
		{
			globals->dw403334 = 0x01;
			PVFV ** esp_281 = esp_19 - 0x04;
			*esp_281 = (PVFV **) &globals->t4020F0;
			*(esp_281 - 0x04) = 0x004020E4;
			if (_initterm_e(*(esp_281 - 0x04), *esp_281) != 0x00)
			{
				*(ebp_12 - 0x04) = ~0x01;
				eax_192.u0 = 0xFF;
				goto l004012C3;
			}
			*esp_281 = (PVFV **) &globals->t4020E0;
			*(esp_281 - 0x04) = 0x004020D8;
			_initterm(*(esp_281 - 0x04), *esp_281);
			globals->dw403334 = 0x02;
		}
		else
		{
			*(ebp_12 - 0x19) = 0x01;
			ebx = DPB(ebx, 0x01, 0);
		}
		ptr32 * esp_74 = esp_19 - 0x04;
		*esp_74 = *(ebp_12 - 0x24);
		fn004015C9(bArg00);
		ptr32 ecx_250 = *esp_74;
		fn00401761();
		ptr32 esp_252 = esp_74 + 0x01;
		ptr32 edi_247 = 0x00;
		if (globals->dw403384 != 0x00)
		{
			*esp_74 = 0x00403384;
			<anonymous> ** esi_246;
			word32 eax_248 = fn0040153F(ecx_250, ebx, 0x00403384, 0x00, out ebx, out esi_246, out edi_247);
			byte al_249 = (byte) eax_248;
			ecx_250 = *esp_74;
			esp_252 = esp_74 + 0x01;
			if (al_249 != 0x00)
			{
				*esp_74 = edi_247;
				*(esp_74 - 0x04) = 0x02;
				*(esp_74 - 0x08) = edi_247;
				<anonymous> * esi_262 = *esi_246;
				fn00401972();
				byte al_267;
				byte SZO_268;
				byte C_269;
				byte Z_270;
				byte bl_271;
				word32 ebp_272;
				word32 eax_273;
				byte SCZO_274;
				byte cl_275;
				word32 esi_276;
				word32 edx_279;
				esi_262();
			}
		}
		word32 eax_94 = fn00401767();
		if (globals->ptr403380 != edi_247)
		{
			ptr32 * esp_210 = esp_252 - 0x04;
			*esp_210 = 0x00403380;
			word32 ebx_212;
			ptr32 * esi_213;
			word32 edi_214;
			word32 eax_215 = fn0040153F(ecx_250, ebx, 0x00403380, edi_247, out ebx_212, out esi_213, out edi_214);
			byte al_216 = (byte) eax_215;
			if (al_216 != 0x00)
			{
				*esp_210 = *esi_213;
				word32 esp_225;
				word32 ecx_226;
				byte al_227;
				byte SZO_228;
				byte C_229;
				byte Z_230;
				byte bl_231;
				word32 ebp_232;
				word32 eax_233;
				byte SCZO_234;
				byte cl_235;
				word32 esi_236;
				word32 edi_237;
				word32 ebx_238;
				word32 edx_239;
				register_thread_local_exe_atexit_callback();
			}
		}
		word32 esp_99;
		word32 ecx_100;
		byte al_101;
		byte SZO_102;
		byte C_103;
		byte Z_104;
		byte bl_105;
		word32 ebp_106;
		word32 eax_107;
		byte SCZO_108;
		byte cl_109;
		word32 esi_110;
		word32 edi_111;
		word32 ebx_112;
		word32 edx_113;
		_p___argv();
		word32 esp_116;
		word32 ecx_117;
		byte al_118;
		byte SZO_119;
		byte C_120;
		byte Z_121;
		byte bl_122;
		word32 ebp_123;
		word32 eax_124;
		byte SCZO_125;
		byte cl_126;
		word32 esi_127;
		word32 edi_128;
		word32 ebx_129;
		word32 edx_130;
		_p___argc();
		struct Eq_380 * esp_133;
		word32 ecx_134;
		byte al_135;
		byte SZO_136;
		byte C_137;
		byte Z_138;
		byte bl_139;
		Eq_62 eax_141;
		byte SCZO_142;
		byte cl_143;
		word32 * esi_144;
		word32 * edi_145;
		word32 ebx_146;
		word32 edx_147;
		get_initial_narrow_environment();
		esp_133->tFFFFFFF8 = eax_141;
		esp_133->dwFFFFFFF4 = *edi_145;
		esp_133->dwFFFFFFF0 = *esi_144;
		Eq_62 eax_157 = fn00401040();
		ptr32 esp_158 = &esp_133->tFFFFFFF8;
		Eq_62 esi_160 = eax_157;
		byte al_161 = fn0040188B();
		if (al_161 == 0x00)
		{
			esp_133->tFFFFFFF8 = eax_157;
			exit(esp_133->tFFFFFFF8);
		}
		if (bl_139 == 0x00)
		{
			word32 esp_194;
			word32 ecx_195;
			byte al_196;
			byte SZO_197;
			byte C_198;
			byte Z_199;
			byte bl_200;
			word32 eax_202;
			byte SCZO_203;
			byte cl_204;
			word32 edi_206;
			word32 ebx_207;
			word32 edx_208;
			cexit();
			esp_158 = esp_194 + ~0x03;
		}
		word32 * esp_182 = esp_158 - 0x04;
		*esp_182 = 0x00;
		*(esp_182 - 0x04) = 0x01;
		fn004015E6(dwArg00, bArg04);
		*(ebp_12 - 0x04) = ~0x01;
		eax_192 = esi_160;
l004012C3:
		word32 ebp_62;
		word32 esi_63;
		word32 edi_64;
		fn004019C6(ebp_12, 0x14, dwArg00, dwArg04, dwArg08, dwArg0C, out ebp_62, out esi_63, out edi_64);
		return eax_192;
	}
	goto l00401172;
}

Eq_522 * fn004013F6(word32 dwArg04, ptr32 dwArg08)
{
	struct Eq_522 * eax_26;
	struct Eq_526 * ecx_13 = dwArg04 + dwArg04->dw003C / 0x0040;
	struct Eq_522 * edx_16 = ecx_13->w0014 + 0x02 + (word32) ecx_13->w0014 / 22;
	struct Eq_522 * esi_19 = edx_16 + (word32) ecx_13->w0006;
	if (edx_16 != esi_19)
	{
		do
		{
			if (dwArg08 >= edx_16->dw000C && dwArg08 < edx_16->dw0008 + edx_16->dw000C)
			{
				eax_26 = edx_16;
				return eax_26;
			}
			edx_16 = edx_16 + 0x01;
		} while (edx_16 != esi_19);
	}
	eax_26 = null;
	return eax_26;
}

byte fn0040143A(word32 dwArg00)
{
	if (fn00401B98() != 0x00)
	{
		word32 edx_32 = fs->ptr0018->dw0004;
l0040145B:
		__lock();
		word32 eax_36;
		__cmpxchg(globals->dw403338, edx_32, 0x00, out eax_36);
		__lock();
		word32 eax_43;
		__cmpxchg(globals->dw403338, edx_32, 0x00, out eax_43);
		if (eax_43 != 0x00)
		{
			if (edx_32 != eax_43)
				goto l0040145B;
			return 0x01;
		}
		else
		{
			return 0x00;
			return 0x00;
		}
	}
	else
		return 0x00;
}

byte fn0040146F(word32 edx, word32 dwArg04)
{
	if (dwArg04 == 0x00)
		globals->b403354 = 0x01;
	fn004019FE(edx);
	fn00401C46();
	if (true)
	{
		fn00401C46();
		if (true)
			return 0x01;
		fn00401C46();
	}
	return 0x00;
}

Eq_628 * fn0040153F(ptr32 ecx, word32 ebx, ptr32 esi, ptr32 edi, ptr32 & ebxOut, ptr32 & esiOut, ptr32 & ediOut)
{
	struct Eq_628 * eax_30;
	struct Eq_67 * ebp_11 = fn00401980(ecx, ebx, esi, edi, dwLoc0C, 0x00402528, 0x08);
	*(ebp_11 - 0x04) = *(ebp_11 - 0x04) & 0x00;
	struct Eq_648 * eax_16 = (struct Eq_648 *) 23117;
	if ((word16 *) 0x00400000 == 23117)
	{
		eax_16 = (struct Eq_648 *) (struct Eq_648 **) 0x0040003C;
		if (eax_16->dw400000 == 0x4550 && eax_16->w400018 == 0x010B)
		{
			*(fp - 0x0C) = ebp_11->dw0008 - 0x00400000;
			*(fp - 0x10) = 0x00400000;
			eax_16 = fn004013F6(dwArg00, dwArg04);
			if (eax_16 != null && eax_16->dw0024 >= 0x00)
			{
				*(ebp_11 - 0x04) = ~0x01;
				eax_30 = (struct Eq_628 *) DPB(eax_16, 0x01, 0);
l004015C3:
				word32 ebp_37;
				word32 esi_38;
				word32 edi_39;
				word32 ebx_40;
				*ebxOut = fn004019C6(ebp_11, 0x08, dwArg00, dwArg04, dwArg08, dwArg0C, out ebp_37, out esi_38, out edi_39);
				return eax_30;
			}
		}
	}
	*(ebp_11 - 0x04) = ~0x01;
	eax_30 = (struct Eq_628 *) DPB(eax_16, 0x00, 0);
	goto l004015C3;
}

void fn004015C9(byte bArg04)
{
	if (fn00401B98() != 0x00 && bArg04 == 0x00)
		globals->dw403338 = 0x00;
	return;
}

void fn004015E6(word32 dwArg04, byte bArg08)
{
	if (globals->b403354 == 0x00 || bArg08 == 0x00)
	{
		fn00401C46();
		fn00401C46();
	}
	return;
}

ui32 fn0040165E()
{
	ui32 eax_16 = globals->dw403004;
	if (eax_16 != 0xBB40E64E && (eax_16 & 0xFFFF0000) != 0x00)
		globals->dw403000 = ~eax_16;
	else
	{
		GetSystemTimeAsFileTime(fp - 0x10);
		ui32 v14_55 = dwLoc0C & 0x00 ^ dwLoc10 & 0x00 ^ GetCurrentThreadId() ^ GetCurrentProcessId();
		QueryPerformanceCounter(fp - 0x18);
		ui32 ecx_69 = dwLoc14 ^ dwLoc18 ^ v14_55 ^ fp - 0x08;
		if (ecx_69 == 0xBB40E64E)
			ecx_69 = ~0x44BF19B0;
		else if ((ecx_69 & 0xFFFF0000) == 0x00)
			ecx_69 = ecx_69 | (ecx_69 | 0x4711) << 0x10;
		globals->dw403004 = ecx_69;
		ecx = ~ecx_69;
		globals->dw403000 = ecx;
	}
	return ecx;
}

void fn00401761()
{
	return;
}

ptr32 fn00401767()
{
	return 0x00403380;
}

void fn0040176D(word32 dwArg00, word32 dwArg04)
{
	if (IsProcessorFeaturePresent(0x17) == 0x00)
	{
		globals->dw403368 = 0x00;
		memset(fp + ~0x0327, 0x00, 0x02CC);
		memset(fp - 0x5C, 0x00, 0x50);
		byte bl_90 = 0x00 - (0x01 - IsDebuggerPresent() == 0x00);
		SetUnhandledExceptionFilter(null);
		if (UnhandledExceptionFilter(fp - 0x0C) == 0x00)
			globals->dw403368 = globals->dw403368 & 0x00 - (-((word32) (bl_90 + 0x01)) == 0x00);
		return;
	}
	else
		__fastfail(dwArg04);
}

bool fn0040188B()
{
	Eq_882 eax_4 = GetModuleHandleW(null);
	if (eax_4 != null && eax_4->unused == 23117)
	{
		struct Eq_896 * eax_42 = eax_4 + eax_4->dw003C / 0x0040;
		if (eax_42->dw0000 == 0x4550 && (eax_42->w0018 == 0x010B && eax_42->dw0074 > 0x0E))
			return eax_42->dw00E8 != 0x00;
	}
	return 0x00;
}

void fn00401972()
{
	word32 esp_3;
	globals->ptr4020D4();
	return;
}

ptr32 fn00401980(ptr32 ecx, word32 ebx, ptr32 esi, ptr32 edi, word32 dwArg00, word32 dwArg04, word32 dwArg08)
{
	ptr32 esp_14 = fp - 0x08 - dwArg08;
	*(esp_14 - 0x04) = ebx;
	*(esp_14 - 0x08) = esi;
	*(esp_14 - 0x0C) = edi;
	ui32 eax_24 = globals->dw403004;
	*(esp_14 - 0x10) = eax_24 ^ fp + 0x08;
	*(esp_14 - 0x14) = dwArg00;
	fs->ptr0000 = fp - 0x08;
	ui32 v11_26 = dwArg04 ^ eax_24;
	if (ecx == 0x00)
	{
		ptr32 ebp_51;
		word32 esi_52;
		word32 edi_53;
		fn004019C6(fp + 0x08, v11_26, ~0x01, ebp, dwArg0C, dwArg10, out ebp_51, out esi_52, out edi_53);
		return ebp_51;
	}
	else
		return fp + 0x08;
}

word32 fn004019C6(Eq_67 * ebp, ui32 dwArg00, word32 dwArg04, ptr32 dwArg08, word32 dwArg0C, word32 dwArg10, ptr32 & ebpOut, ptr32 & esiOut, ptr32 & ediOut)
{
	fs->dw0000 = *(ebp - 0x10);
	word32 ebp_22 = ebp->dw0000;
	*ebpOut = ebp_22;
	ebp->dw0000 = dwArg00;
	word32 edi_14 = dwArg08;
	*ediOut = edi_14;
	word32 esi_17 = dwArg0C;
	*esiOut = esi_17;
	if (dwArg00 == 0x00)
	{
		*(ebp - 0x04) = ebp_22;
		*(ebp - 0x08) = ebp->dw0010;
		*(ebp - 0x0C) = ebp->dw000C;
		*(ebp - 0x10) = ebp->dw0008;
		*(ebp - 0x14) = ebp->dw0004;
		*(ebp - 0x18) = 0x0040108B;
		*(ebp - 0x1C) = 0x00403004;
		struct Eq_1062 * esp_57;
		word32 ebp_58;
		word32 ecx_59;
		struct Eq_1065 * fs_60;
		word32 edi_61;
		word32 esi_62;
		word32 ebx_63;
		byte SCZO_64;
		except_handler4_common();
		word32 ebp_68;
		*ebpOut = esp_57->dw0014;
		return ebx_63;
	}
	else
		return dwArg10;
}

void fn004019FE(word32 edx)
{
	globals->dw40336C = globals->dw40336C & 0x00;
	globals->dw403010 = globals->dw403010 | 0x01;
	if (IsProcessorFeaturePresent(0x0A) != 0x00)
	{
		ui32 edi_135;
		globals->dw403010 = globals->dw403010 | 0x02;
		globals->dw40336C = 0x01;
		int32 eax_89;
		word32 ebx_90;
		word32 ecx_91;
		word32 edx_92;
		__cpuid(0x00, 0x00, &eax_89, &ebx_90, &ecx_91, &edx_92);
		ui32 eax_124;
		word32 ebx_125;
		ui32 ecx_126;
		word32 edx_127;
		__cpuid(0x01, 0x00, &eax_124, &ebx_125, &ecx_126, &edx_127);
		if ((edx_92 ^ 0x49656E69 | ecx_91 ^ 1818588270 | ebx_90 ^ 1970169159) == 0x00 && ((eax_124 & 0x0FFF3FF0) == 0x000106C0 || ((eax_124 & 0x0FFF3FF0) == 0x00020660 || ((eax_124 & 0x0FFF3FF0) == 0x00020670 || ((eax_124 & 0x0FFF3FF0) == 0x00030650 || ((eax_124 & 0x0FFF3FF0) == 0x00030660 || (eax_124 & 0x0FFF3FF0) == 0x00030670))))))
		{
			ui32 edi_245 = globals->dw403370;
			globals->dw403370 = edi_245 | 0x01;
			edi_135 = edi_245 | 0x01;
		}
		else
			edi_135 = globals->dw403370;
		if (eax_89 >= 0x07)
		{
			word32 eax_210;
			ui32 ebx_211;
			word32 ecx_212;
			word32 edx_213;
			__cpuid(0x07, 0x00, &eax_210, &ebx_211, &ecx_212, &edx_213);
			if ((ebx_211 & 0x0200) != 0x00)
				globals->dw403370 = edi_135 | 0x02;
		}
		if ((ecx_126 & 0x00100000) != 0x00)
		{
			globals->dw403010 = globals->dw403010 | 0x04;
			globals->dw40336C = 0x02;
			if ((ecx_126 & 0x08000000) != 0x00 && ((ecx_126 & 0x10000000) != 0x00 && (((word32) __xgetbv(0x00) & 0x06) == 0x06 && true)))
			{
				ui32 eax_189 = globals->dw403010;
				globals->dw40336C = 0x03;
				globals->dw403010 = eax_189 | 0x08;
				if ((bLoc14 & 0x20) != 0x00)
				{
					globals->dw40336C = 0x05;
					globals->dw403010 = eax_189 | 0x08 | 0x20;
				}
			}
		}
	}
	return;
}

word32 fn00401B98()
{
	return (word32) (globals->dw403014 != 0x00);
}

void fn00401C46()
{
	return;
}

